<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EQ Audio Player</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>

    <style>
        :root { 
            --bg: #121212; --card: #1e1e1e; --txt: #ffffff; --accent: #1abc9c; 
            --inner-bg: rgba(255,255,255,0.05); --border: rgba(255,255,255,0.1);
            --header-bg: rgba(255,255,255,0.05);
        }
        [data-theme="light"] { 
            --bg: #e9ecef; --card: #ffffff; --txt: #212529; --accent: #3498db; 
            --inner-bg: #f8f9fa; --border: rgba(0,0,0,0.1);
            --header-bg: #ffffff;
        }

        body { background-color: var(--bg); color: var(--txt); min-height: 100vh; display: flex; align-items: center; transition: all 0.4s ease; font-family: 'Segoe UI', sans-serif; margin: 0; }
        .card { background-color: var(--card); color: var(--txt); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; height: 100%; transition: background 0.3s; }

        /* --- UPDATED FLEX LAYOUT WITH 200px ART --- */
        .player-header-flex {
            display: flex;
            align-items: center;
            gap: 25px;
            margin-bottom: 30px;
        }

        .main-album-art {
            width: 200px; height: 200px; min-width: 200px;
            border-radius: 15px; overflow: hidden;
            background: var(--inner-bg);
            border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        #albumArtImg { width: 100%; height: 100%; object-fit: cover; }
        #artIcon { font-size: 5rem; opacity: 0.3; }

        .now-playing-info {
            flex-grow: 1;
            background: var(--accent); color: white; 
            padding: 25px; border-radius: 15px; 
            text-align: left;
            display: flex; flex-direction: column; justify-content: center;
            height: 200px; /* Matched to album art height */
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }

        /* --- UI ELEMENTS --- */
        .playlist-header { background-color: var(--header-bg); border-bottom: 1px solid var(--border); padding: 1rem; }
        .playlist-container {
            flex-grow: 1; overflow-y: auto; max-height: 480px; background: var(--inner-bg); margin: 15px; border-radius: 12px;
            scrollbar-width: none;
        }
        .playlist-container::-webkit-scrollbar { display: none; }

        .playlist-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 0.85rem; display: flex; align-items: center; gap: 10px; }
        .playlist-item.active { color: var(--accent); font-weight: bold; background: rgba(26, 188, 156, 0.1); border-left: 4px solid var(--accent); }

        .eq-container { display: flex; justify-content: space-around; background: var(--inner-bg); padding: 20px 10px; border-radius: 15px; border: 1px solid var(--border); }
        .range-wrapper { height: 130px; width: 35px; display: flex; justify-content: center; align-items: center; }
        input[type="range"].vertical { appearance: none; width: 120px; height: 4px; background: rgba(128,128,128,0.3); transform: rotate(-90deg); cursor: pointer; }
        input[type="range"].vertical::-webkit-slider-thumb { appearance: none; width: 16px; height: 16px; background: var(--accent); border-radius: 50%; border: 2px solid #fff; }

        .control-btn { font-size: 2.3rem; color: var(--accent); background: none; border: none; transition: 0.2s; }
        .control-btn:hover { transform: scale(1.1); }
        .control-btn:disabled { opacity: 0.2; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row g-4 align-items-stretch">
        <div class="col-lg-8">
            <div class="card shadow-lg p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0 fw-bold">EQ Audio Player</h5>
                    <button id="themeToggle" class="btn btn-outline-secondary btn-sm"><i id="themeIcon" class="bi bi-moon-stars-fill"></i></button>
                </div>

                <div class="player-header-flex">
                    <div class="main-album-art">
                        <img id="albumArtImg" src="" alt="" style="display:none;">
                        <i id="artIcon" class="bi bi-music-note-beamed"></i>
                    </div>

                    <div class="now-playing-info shadow-sm">
                        <div class="fw-bold text-truncate fs-4 mb-1" id="metaTitle">No track selected</div>
                        <div class="fs-6 opacity-80 text-truncate" id="metaArtist">Please load your music</div>
                    </div>
                </div>

                <div class="text-center">
                    <div class="d-flex align-items-center justify-content-center gap-4 mb-4">
                        <button id="prevBtn" class="control-btn"><i class="bi bi-skip-backward-circle-fill"></i></button>
                        <audio id="audioSource" controls class="flex-grow-1" style="height: 40px;"></audio>
                        <button id="nextBtn" class="control-btn"><i class="bi bi-skip-forward-circle-fill"></i></button>
                    </div>

                    <div class="eq-container mb-4" id="eqBars"></div>
                </div>

                <div class="d-flex gap-4 justify-content-center border-top pt-3">
                    <button id="exportBtn" class="btn btn-link btn-sm text-decoration-none text-success fw-bold">EXPORT EQ</button>
                    <label for="importInput" class="btn btn-link btn-sm text-decoration-none text-info fw-bold" style="cursor:pointer">IMPORT EQ</label>
                    <input type="file" id="importInput" accept=".json" class="d-none">
                    <button id="resetBtn" class="btn btn-link btn-sm text-decoration-none text-danger fw-bold">RESET EQ</button>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-lg d-flex flex-column">
                <div class="playlist-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold">MY LIBRARY</h6>
                    <button id="clearBtn" class="btn btn-sm text-danger p-0"><i class="bi bi-trash3"></i></button>
                </div>
                <div id="playlist" class="playlist-container"></div>
                <div class="p-3 border-top mt-auto">
                    <label for="fileInput" class="btn btn-primary w-100 fw-bold py-2 shadow-sm">LOAD MUSIC</label>
                    <input type="file" id="fileInput" accept="audio/*" multiple class="d-none">
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const jsmediatags = window.jsmediatags;
    const audioEl = document.getElementById('audioSource');
    const playlistEl = document.getElementById('playlist');
    const albumArtImg = document.getElementById('albumArtImg');
    const artIcon = document.getElementById('artIcon');
    const metaTitle = document.getElementById('metaTitle');
    const metaArtist = document.getElementById('metaArtist');

    audioEl.volume = 0.05; // Default volume 5%

    let playlist = [];
    let currentIndex = 0;
    let theme = localStorage.getItem('theme') || 'dark';
    let savedGains = JSON.parse(localStorage.getItem('eq-gains') || '[0,0,0,0,0]');
    
    let audioCtx = null;
    let source = null;
    let filters = [];
    const freqs = [60, 250, 1000, 4000, 16000];

    const eqBars = document.getElementById('eqBars');
    freqs.forEach((f, i) => {
        const label = f >= 1000 ? (f/1000)+'kHz' : f+'Hz';
        eqBars.innerHTML += `
            <div class="slider-unit text-center">
                <span class="db-label small" style="font-size:0.7rem;" id="db${i}">${savedGains[i]}dB</span>
                <div class="range-wrapper"><input type="range" class="vertical eq-slider" min="-20" max="20" value="${savedGains[i]}" data-index="${i}"></div>
                <span class="hz-label d-block small mt-2" style="font-size:0.75rem;">${label}</span>
            </div>`;
    });

    function initAudioEngine() {
        if (audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        source = audioCtx.createMediaElementSource(audioEl);
        let lastNode = source;
        filters = freqs.map((f, i) => {
            const filter = audioCtx.createBiquadFilter();
            filter.type = "peaking";
            filter.frequency.value = f;
            filter.gain.value = savedGains[i];
            lastNode.connect(filter);
            lastNode = filter;
            return filter;
        });
        lastNode.connect(audioCtx.destination);
    }

    function loadTrack(index) {
        if (index < 0 || index >= playlist.length) return;
        initAudioEngine();
        if (audioCtx.state === 'suspended') audioCtx.resume();

        currentIndex = index;
        const file = playlist[currentIndex];
        if (audioEl.src) URL.revokeObjectURL(audioEl.src);
        audioEl.src = URL.createObjectURL(file);
        
        const currentVol = audioEl.volume;
        audioEl.play().then(() => { audioEl.volume = currentVol; });

        jsmediatags.read(file, {
            onSuccess: (tag) => {
                const { title, artist, picture } = tag.tags;
                metaTitle.innerText = title || file.name.replace(/\.[^/.]+$/, "");
                metaArtist.innerText = artist || "Unknown Artist";
                if (picture) {
                    const data = picture.data;
                    const format = picture.format;
                    let base64String = "";
                    for (let i = 0; i < data.length; i++) base64String += String.fromCharCode(data[i]);
                    albumArtImg.src = `data:${format};base64,${window.btoa(base64String)}`;
                    albumArtImg.style.display = 'block'; artIcon.style.display = 'none';
                } else { resetArt(); }
            },
            onError: () => { metaTitle.innerText = file.name; metaArtist.innerText = "Unknown Artist"; resetArt(); }
        });
        renderPlaylist();
    }

    function renderPlaylist() {
        playlistEl.innerHTML = playlist.length ? '' : '<div class="p-5 text-center opacity-50">Library empty</div>';
        playlist.forEach((file, i) => {
            const item = document.createElement('div');
            item.className = `playlist-item ${i === currentIndex ? 'active' : ''}`;
            item.innerHTML = `<i class="bi bi-play-fill"></i> <span class="text-truncate">${file.name}</span>`;
            item.onclick = () => loadTrack(i);
            playlistEl.appendChild(item);
        });
        document.getElementById('prevBtn').disabled = (currentIndex <= 0);
        document.getElementById('nextBtn').disabled = (currentIndex >= playlist.length - 1);
    }

    document.querySelectorAll('.eq-slider').forEach(slider => {
        slider.oninput = (e) => {
            const i = e.target.dataset.index;
            const val = parseInt(e.target.value);
            document.getElementById(`db${i}`).innerText = val + 'dB';
            savedGains[i] = val;
            localStorage.setItem('eq-gains', JSON.stringify(savedGains));
            if (filters[i]) filters[i].gain.setTargetAtTime(val, audioCtx.currentTime, 0.01);
        };
    });

    document.getElementById('resetBtn').onclick = () => {
        savedGains = [0, 0, 0, 0, 0];
        localStorage.setItem('eq-gains', JSON.stringify(savedGains));
        document.querySelectorAll('.eq-slider').forEach((slider, i) => {
            slider.value = 0;
            document.getElementById(`db${i}`).innerText = '0dB';
            if (filters[i]) filters[i].gain.setTargetAtTime(0, audioCtx.currentTime, 0.01);
        });
    };

    document.getElementById('fileInput').onchange = (e) => {
        const files = Array.from(e.target.files).filter(f => f.type.startsWith('audio/'));
        if (files.length > 0) {
            const wasEmpty = playlist.length === 0;
            playlist = [...playlist, ...files];
            renderPlaylist();
            if (wasEmpty) loadTrack(0);
        }
    };

    document.getElementById('prevBtn').onclick = () => loadTrack(currentIndex - 1);
    document.getElementById('nextBtn').onclick = () => loadTrack(currentIndex + 1);
    audioEl.onended = () => { if (currentIndex < playlist.length - 1) loadTrack(currentIndex + 1); };

    document.getElementById('themeToggle').onclick = () => {
        theme = (theme === 'dark') ? 'light' : 'dark';
        localStorage.setItem('theme', theme);
        applyTheme();
    };

    function applyTheme() {
        document.documentElement.setAttribute('data-theme', theme);
        document.getElementById('themeIcon').className = (theme === 'dark') ? 'bi bi-moon-stars-fill' : 'bi bi-sun-fill';
    }

    document.getElementById('exportBtn').onclick = () => {
        const blob = new Blob([JSON.stringify({gains: savedGains, theme})], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = "eq_settings.json"; a.click();
    };

    document.getElementById('clearBtn').onclick = () => {
        if(confirm("Clear library?")) {
            playlist = []; currentIndex = 0; audioEl.pause(); audioEl.src = "";
            metaTitle.innerText = "No track selected"; metaArtist.innerText = "Please load your music";
            resetArt(); renderPlaylist();
        }
    };

    function resetArt() { albumArtImg.src = ""; albumArtImg.style.display = 'none'; artIcon.style.display = 'block'; }
    applyTheme();
    renderPlaylist();
</script>
</body>
</html>